pipeline {
    agent any

    environment {
        IMAGE_NAME = "airline-management-system"
        CONTAINER_NAME = "airline-management-container"
        AWS_EC2_IP = "54.210.167.7"
        SSH_CREDENTIALS_ID = "ec2-ssh-key"
        PROJECT_DIR = "airline-management-system" // inner directory that has pom.xml and Dockerfile
    }

    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/Moulik116/airline-management-system', branch: 'main'
            }
        }

        stage('Build Maven Project') {
            steps {
                dir("${PROJECT_DIR}") {
                    sh 'mvn clean install'
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir("${PROJECT_DIR}") {
                    sh "docker build -t $IMAGE_NAME ."
                }
            }
        }

        stage('Push Docker Image (optional)') {
            when {
                expression { return false } // Set to true if pushing to DockerHub or ECR
            }
            steps {
                echo 'Skipping image push (not enabled)'
            }
        }

        stage('Deploy to EC2') {
            steps {
                sshagent (credentials: [env.SSH_CREDENTIALS_ID]) {
                    sh """
                    ssh -o StrictHostKeyChecking=no ec2-user@$AWS_EC2_IP '
                        docker stop $CONTAINER_NAME || true && \
                        docker rm $CONTAINER_NAME || true && \
                        docker rmi $IMAGE_NAME || true && \
                        cd ~/app/$PROJECT_DIR && \
                        git pull && \
                        docker build -t $IMAGE_NAME . && \
                        docker run -d -p 8082:8082 --name $CONTAINER_NAME $IMAGE_NAME
                    '
                    """
                }
            }
        }
    }

    post {
        success {
            echo " Deployed successfully"
        }
        failure {
            echo " Build/Deploy failed"
        }
    }
}
